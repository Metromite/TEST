<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-analytics.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA9n5lGdlNkgMmC570jArJwKY5P2c_XkcY",
    authDomain: "dispatchsystem-23f47.firebaseapp.com",
    databaseURL: "https://dispatchsystem-23f47-default-rtdb.firebaseio.com",
    projectId: "dispatchsystem-23f47",
    storageBucket: "dispatchsystem-23f47.firebasestorage.app",
    messagingSenderId: "131590857859",
    appId: "1:131590857859:web:5959d9655fdd0ba7b6",
    measurementId: "G-49GJE4J123"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getDatabase(app);

  // ================= TEST CONNECTION =================
  set(ref(db, 'test/connection'), {
    message: "Firebase is connected!",
    timestamp: Date.now()
  });

  const zones = document.querySelectorAll('.zone');
  const bays = document.querySelectorAll('.bay');
  const dispatchedArea = document.getElementById('dispatchedZones');
  const pendingArea = document.getElementById('pendingZones');

  // ================= Drag & Drop =================
  zones.forEach(zone => {
    zone.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', zone.id);
      setTimeout(() => zone.style.display = 'none', 0);
    });
    zone.addEventListener('dragend', () => zone.style.display = 'block');
  });

  [...bays, dispatchedArea, pendingArea].forEach(area => {
    area.addEventListener('dragover', e => e.preventDefault());
    area.addEventListener('drop', e => {
      e.preventDefault();
      const zoneId = e.dataTransfer.getData('text/plain');
      const zone = document.getElementById(zoneId);
      if (!zone) return;

      let newStatus;
      if (area.classList.contains('bay')) newStatus = 'in-gate';
      else if (area.id === 'dispatchedZones') newStatus = 'dispatched';
      else if (area.id === 'pendingZones') newStatus = 'pending';

      moveZone(zone, area);
      updateZoneInFirebase(zone.id, newStatus, area.id);
    });
  });

  function moveZone(zone, targetArea) {
    if (zone.dataset.interval) { clearInterval(zone.dataset.interval); delete zone.dataset.interval; }
    zone.classList.remove('in-gate', 'dispatched', 'waiting');
    const oldTimer = zone.querySelector('.timer'); if(oldTimer) oldTimer.remove();
    const oldDispatch = zone.querySelector('.dispatched-time'); if(oldDispatch) oldDispatch.remove();
    targetArea.appendChild(zone);
    if (targetArea.classList.contains('bay')) zone.classList.add('in-gate');
    else if (targetArea.id === 'dispatchedZones') zone.classList.add('dispatched');
    else if (targetArea.id === 'pendingZones') zone.classList.add('waiting');
  }

  function updateZoneInFirebase(zoneId, status, areaId) {
    const now = Date.now();
    const data = { status };
    if (status === 'in-gate') { data.startTime = now; data.bayId = areaId; }
    if (status === 'dispatched') data.dispatchedTime = now;
    set(ref(db, 'zones/' + zoneId), data);
  }

  // ================= Real-time Listener =================
  const zonesRef = ref(db, 'zones/');
  onValue(zonesRef, snapshot => {
    const zonesData = snapshot.val();
    if (!zonesData) return;
    for (const zoneId in zonesData) {
      const zone = document.getElementById(zoneId);
      if (!zone) continue;

      const { status, startTime, dispatchedTime, bayId } = zonesData[zoneId];

      if (status === 'pending') pendingArea.appendChild(zone);
      else if (status === 'in-gate') {
        const bay = document.getElementById(bayId) || document.querySelector('.dispatch-bays .bay');
        bay.appendChild(zone);
        if (startTime) startTimer(zone, startTime);
      } else if (status === 'dispatched') {
        dispatchedArea.appendChild(zone);
        if (dispatchedTime) showDispatchedTime(zone, dispatchedTime);
      }
    }
  });

  function startTimer(zone, startTime) {
    if (zone.dataset.interval) clearInterval(zone.dataset.interval);
    const timerDisplay = zone.querySelector('.timer') || document.createElement('span');
    timerDisplay.classList.add('timer');
    if (!zone.contains(timerDisplay)) zone.appendChild(timerDisplay);
    const interval = setInterval(() => {
      const diff = Math.floor((Date.now() - startTime) / 1000);
      const minutes = Math.floor(diff / 60);
      const seconds = diff % 60;
      timerDisplay.textContent = `‚è± ${minutes}m ${seconds}s`;
    }, 1000);
    zone.dataset.interval = interval;
  }

  function showDispatchedTime(zone, dispatchedTime) {
    const label = zone.querySelector('.dispatched-time') || document.createElement('span');
    label.classList.add('dispatched-time');
    label.textContent = `(Dispatched at: ${new Date(dispatchedTime).toLocaleTimeString()})`;
    if (!zone.contains(label)) zone.appendChild(label);
  }

</script>
